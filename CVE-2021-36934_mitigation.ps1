# Fix HiveNightmare ACLs and snapshots

# Forked from https://github.com/GossiTheDog/HiveNightmare

# Schedule to run as SYSTEM in a deployment tool, test locally first
# Do not run on Windows Server in case you use VSS for backups

# $checkPermissions = icacls c:\Windows\System32\config\sam
# if ($checkPermissions -like '*BUILTIN\Users:(I)(RX*)*') {

[cmdletbinding()]    

param()

#Requires -RunAsAdministrator

$OutputFile = "$($env:temp)\$($env:computername)_CVE-2021-36934_report.txt"
Write-Host $OutputFile
$Version = 'CVE-2021-36934_mitigation 1.1'
$AllOk = '[All Ok]'
$AllFixedStr = '[All fixed]'


function Get-CVE-2021-36934_Vulnerable_ACLE {
    $filenames = @('SAM','SECURITY','SYSTEM')
    $forbiden = @('BUILTIN\Users','VORDEFINIERT\Benutzer','VORDEFINIERT\Users')
    foreach ($n in $filenames) {
        try {
            $fullFileName = "$($env:windir)\system32\config\$n"
            $acl = (get-acl $fullFileName -ErrorAction Stop).access.IdentityReference
            Write-Verbose "$fullFileName ==> $acl" 
        } catch {
            return $Error[0].Exception.Message
        }
        $notAllowed = $acl | Where-Object {$forbiden -contains $_}
        if ($notAllowed -ne $null) {
            return [string]$notAllowed
        }
    }
    return ''    
}


$WrongACL = Get-CVE-2021-36934_Vulnerable_ACLE

if ([string]::IsNullOrEmpty($WrongACL)) {
    if (!(Test-Path -LiteralPath $OutputFile)) {
        $Version | Tee-Object -FilePath $OutputFile
    }
    if ( (Get-Content $OutputFile -Tail 1) -ne $AllOk ) {
        $AllOk | Tee-Object -FilePath $OutputFile -Append
    } else { $AllOk }  
} else {
    $Version | Tee-Object -FilePath $OutputFile
    $WrongACL | Tee-Object -FilePath $OutputFile -Append
    icacls "$($env:windir)\system32\config\*.*" /inheritance:e
    vssadmin delete shadows /quiet /all
    
    '=== Mitigation results ===' | Tee-Object -FilePath $OutputFile -Append
    $AllFixed = $true

    if ( [string]::IsNullOrEmpty( (Get-CVE-2021-36934_Vulnerable_ACLE) ) ) { 
        '[ACL Ok] Files permissions are correct.' | Tee-Object -FilePath $OutputFile -Append 
    } else {
        $AllFixed = $false
        '[ACL FAILED]' | Tee-Object -FilePath $OutputFile -Append 
    }
    
    if (((Get-CimInstance Win32_ShadowStorage).UsedSpace) -eq 0) {
        '[VSS Ok] Successfully deleted old volume shadow copies.' | Tee-Object -FilePath $OutputFile -Append
    } else {
        $AllFixed = $false
        '[VSS FAILED]' | Tee-Object -FilePath $OutputFile -Append
    }

    if ($AllFixed) { $AllFixedStr | Tee-Object -FilePath $OutputFile -Append }

}

#create new shadow
# if ($vulnerable -eq $true -and $shadowSucces -eq $true -and $permissionsSucces -eq $true) {
#     wmic shadowcopy call create Volume='C:\'
#     Write-Host ""
# }
